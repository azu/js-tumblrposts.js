/*!
 * TumblrPosts 
 * Copyright (c) 2010, matsukaze.
 * 
 * @version 1.3
 * @author mach3
 * @requires jQuery <http://jquery.com>
 */
/**
 * TumblrPosts
 *
 * @class
 * @constructor
 */
var TumblrPosts=function(t){this.option=$.extend({},this.option),this.config(t),this.$=$(this),this.on(this.EVENT_COMPLETE,$.proxy(this._createTagData,this))};!function(t,s){t.EVENT_COMPLETE="complete",t.EVENT_PROGRESS="progress",t.option={url:"/api/read/json/",restPath:"/api/read/json/",domain:null,maxNum:0,step:50},t.$=null,t.offset=0,t.posts=[],t.tags=[],/**
	 * Config
	 * - pass the string name to get the value
	 * - pass the object to set the value
	 * - pass none to get the all values
	 * - if arg has "domain", "url" will be updated
	 *
	 * @param String|Object arg (optional)
	 */
t.config=function(t){return"undefined"==typeof t?this.option:"string"==typeof t?this.option[t]:("[object Object]"===Object.prototype.toString.call(t)&&(s.extend(this.option,t),"domain"in t&&this.config("domain")&&this.config({url:"http://"+this.config("domain")+this.config("restPath")})),this)},/**
	 * Aliase to jQuery.fn.on()
	 */
t.on=function(){this.$.on.apply(this.$,arguments)},t.bind=t.on,/**
	 * Aliase to jQuery.fn.off()
	 */
t.off=function(){this.$.off.apply(this.$,arguments)},t.unbind=t.off,/**
	 * Aliase to jQuery.fn.trigger()
	 */
t.trigger=function(){this.$.trigger.apply(this.$,arguments)},/**
	 * Start to load files by API
	 */
t.run=function(t){var i,o;if(t){if(!t.posts.length)return void this.trigger(this.EVENT_COMPLETE);for(i=0;i<t.posts.length;i+=1){if(this.posts.length>=this.config("maxNum"))return void this.trigger(this.EVENT_COMPLETE);o=t.posts[i],this.posts.push(o),o.tags&&(this.tags=this.tags.concat(o.tags))}this.offset+=this.config("step"),this.trigger(this.EVENT_PROGRESS)}else this.posts=[],this.tags=[];return s.ajax({url:this.option.url,data:{start:this.offset,num:this.config("step")},dataType:"jsonp",success:s.proxy(this.run,this)}),this},t._createTagData=function(){var t,s,i;for(s={},t=0;t<this.tags.length;t++)i=this.tags[t],s[i]=s[i]?s[i]+1:1;this.tags=[];for(t in s)this.tags.push({name:t,count:s[t]})},/**
	 * Get the posts
	 *
	 * @param Number offset (optional)
	 * @param Number count (optional)
	 * @return Array
	 */
t.getPosts=function(t,i){var o=[];return t=t||0,i=i||10,s.each(this.posts,function(s,n){return t>s?void 0:s>=t+i?!1:void o.push(n)}),o},/**
	 * Get the tags
	 *
	 * @param String order (optinal)
	 * @return Array
	 */
t.getTags=function(t){var s=this.tags;return t&&s.sort(function(s,i){return"asc"===t?s.count-i.count:"desc"===t?i.count-s.count:void 0}),s},/**
	 * Get the title string from post object
	 * 
	 * @param Object post
	 * @param Number count (optional)
	 * @return String
	 */
t.getTitleByPost=function(t,s){var i=t["regular-title"]||t["photo-caption"]||t["video-caption"]||t["regular-body"]||t.type||"";return i=i.replace(/\<.+?\>/gi,""),i=s?i.substr(0,s):i}}(TumblrPosts.prototype,jQuery);