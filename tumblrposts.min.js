/*
 * TumblrPost Class 
 * Copyright (c) 2010, matsukaze.
 * @version 1.2
 * @author mach3
 * @requires jQuery <http://jquery.com>, jQuery.class.js <http://github.com/mach3/js-jquery-class>
 */
var TumblrPosts=Class.create();TumblrPosts.prototype={EVENT_COMPLETE:"complete",EVENT_PROGRESS:"progress",config:{domain:null,maxNum:0},api:"/api/read/json/",postsTotal:0,posts:[],allTags:null,tags:null,offset:0,num:50,initialize:function(a){$.extend(this.config,a);this.api=(this.config.domain)?"http://"+this.config.domain+this.api:this.api},run:function(d,b){var c=this,a=false;if(!!d){this.postsTotal=d["posts-total"];this.allTags=this.allTags||"";if(!d.posts.length){a=true}else{$.each(d.posts,function(e,f){if((c.config.maxNum>0&&c.posts.length>=c.config.maxNum)){a=true;return false}c.posts.push(f);if(!f.tags){return}c.allTags+=","+f.tags.join(",")});if(this.posts.length>=this.postsTotal){a=true}}if(a){this.trigger(this.EVENT_COMPLETE);return}else{this.offset+=this.num;this.trigger(this.EVENT_PROGRESS)}}$.ajax({url:this.api,data:{start:this.offset,num:this.num},dataType:"jsonp",success:function(f,e){c.run(f,e)}})},getTags:function(){var b=this,a={};if(this.tags===null){this.allTags=(this.allTags.replace(/^,/,"")).split(",");$.each(this.allTags,function(d,c){a[c]=(a[c])?a[c]+1:1});this.tags=[];$.each(a,function(c,d){b.tags.push({name:c,count:d})});this.tags.sort(function(d,c){return c.count-d.count})}return this.tags},getPosts:function(c,b){var c=c||0,b=b||10,a=[];$.each(this.posts,function(d,e){if(d<c){return}if(d>c+b){return false}a.push(e)});return a},getTitleByPost:function(a,b){var c=a["regular-title"]||a["photo-caption"]||a["video-caption"]||a["regular-body"]||a.type||"";c=c.replace(/\<.+?\>/gi,"");c=(b)?c.substr(0,b):c;return c},getLoadedRate:function(){return Math.floor(100*this.posts.length/Math.min(this.postsTotal,(this.config.maxNum||this.postsTotal)))}};